---
title: "Main_test - Group 12"
author: 
  - Qing Gao (qg2175)
  - Yuqiao Liu (yl4278)
  - Ivan Wolansky (iaw2110)
  - Xiyao Yan (xy2431)
  - Huizhe Zhu (hz2657)
date: "3/31/2020"
output: html_document
---

```{r message=FALSE}
if(!require("EBImage")){
  install.packages("BiocManager") 
  BiocManager::install("EBImage")
}
if(!require("R.matlab")){
  install.packages("R.matlab")
}
if(!require("readxl")){
  install.packages("readxl")
}

if(!require("dplyr")){
  install.packages("dplyr")
}
if(!require("readxl")){
  install.packages("readxl")
}

if(!require("ggplot2")){
  install.packages("ggplot2")
}

if(!require("caret")){
  install.packages("caret")
}

if(!require("glmnet")){
  install.packages("glmnet")
}

if(!require("caret")){
  install.packages("caret")
}

if(!require("MLmetrics")){
  install.packages("MLmetrics")
}

if(!require("gbm")){
  install.packages("gbm")
}
```

# TESTING MODELS

### Step 0: set up controls for evaluation experiments.

```{r, eval=FALSE}
set.seed(1234)
```

In this chunk, we have a set of controls for the evaluation experiments. 

+ (T/F) process features
+ (T/F) testing our trained model on new data

```{r, eval=FALSE}
run.feature <- TRUE # process features for data

testing <- TRUE # run model on a new, never seen before, dataset
```

### Step 1 set work directories

Provide directories for training/testing images. Training/testing images and training/testing fiducial points will be in different subfolders. 
```{r, eval=FALSE}
if (testing) {
  test_dir <- "../data/test_set/" # This will be modified for different data sets.
  test_image_dir <- paste(test_dir, "images/", sep="")
  test_pt_dir <- paste(test_dir,  "points/", sep="")
  test_label_path <- paste(test_dir, "label.csv", sep="") 
}
```

### Step 2: import data 
```{r, eval=FALSE}
if (testing) {
  info <- read.csv(test_label_path)
}
```

```{r, eval=FALSE}
if (testing) {
  n_files <- length(list.files(test_image_dir))

  image_list <- list()
  for(i in 1:100){
   image_list[[i]] <- readImage(paste0(test_image_dir, sprintf("%04d", i), ".jpg"))
  }
}
```

Fiducial points are stored in matlab format. In this step, we read them and store them in a list.
```{r, eval=FALSE}
if (testing) {
  #function to read fiducial points
  #input: index
  #output: matrix of fiducial points corresponding to the index
  readMat.matrix <- function(index){
       return(round(readMat(paste0(test_pt_dir, sprintf("%04d", index), ".mat"))[[1]],0))
  }
  
  test_fiducial_pt_list <- lapply(1:n_files, readMat.matrix)
  save(test_fiducial_pt_list, file="../output/test_fiducial_pt_list.RData")
}
```

### Step 3: Feature extraction

```{r, eval=FALSE}
source("../lib/feature_baseline.R")
source("../lib/feature_regression.R")

if(testing & run.feature){
  tm_feature_baseline <- system.time(all_test_data_baseline <- feature_baseline(test_fiducial_pt_list, seq(1, nrow(info), 1)))
  
  tm_feature_lasso <- system.time(all_test_data_lasso <- feature_regression(test_fiducial_pt_list, seq(1, nrow(info), 1)))
  
  save(all_test_data_baseline, file="../output/feature_test_baseline.RData")
  save(all_test_data_lasso, file="../output/feature_test_lasso.RData")
}
```

```{r, eval=FALSE}
source("../lib/test_gbm.R")
source("../lib/regression.test.R")
```

### Step 4: Import Fitted Models

```{r, eval=FALSE}
if(testing) {
  load(file="../output/gbm.baseline")
  load(file="../output/cv_lasso_models.RData")
}
```

```{r, eval=FALSE}
labels_prediction <- read.csv("../output/labels_prediction.csv")
```

### Step 5: Make Predictions

```{r, eval=FALSE}
if (testing) {
  tm_test_baseline <- system.time(labels_prediction$Baseline <- test_gbm(gbm.fit=gbm.baseline,
                                                                    input.test=all_test_data_baseline, 
                                                                    n=100))
  
  tm_test_lasso <- system.time(labels_prediction$Advanced <- regression.test(cv_lasso_models, all_test_data_lasso))
  
  write.csv(labels_prediction, "../output/labels_prediction.csv")
} 
```

### Summarize Running Time

```{r, eval=FALSE}
cat("Time for constructing baseline features =", tm_feature_baseline[1], "s \n")
cat("Time for testing baseline model:", tm_test_baseline[1], "s \n")
cat("Time for constructing LASSO features =", tm_feature_lasso[1], "s \n")
cat("Time for testing the LASSO model =", tm_test_lasso[1], "s \n")
```
